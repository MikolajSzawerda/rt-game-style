# AdaAttN baseline - Attention-based Arbitrary Neural Style Transfer
# https://github.com/Huage001/AdaAttN

set dotenv-load

# Paths - all data in ../data/
data_dir := "../data"
coco_dir := data_dir / "coco/val2017"
style_dir := data_dir / "style"
weights_dir := data_dir / "weights/adaattn"
outputs_dir := data_dir / "outputs"

# Google Drive file IDs for pretrained weights
# AdaAttN_model.zip contains: vgg_normalised.pth, AdaAttN/latest_net_*.pth
gdrive_model_id := "1XvpD1eI4JeCBIaW5uwMT6ojF_qlzM_lo"

# =============================================================================
# SETUP
# =============================================================================

setup: init-submodule sync download-weights
    @echo "✓ AdaAttN ready!"

init-submodule:
    #!/usr/bin/env bash
    set -euo pipefail
    [ -f "repo/README.md" ] && echo "Submodule OK" && exit 0
    cd ../.. && git submodule update --init baselines/adaattn/repo

sync:
    uv sync

# Download pretrained weights from Google Drive
download-weights: sync
    #!/usr/bin/env bash
    set -euo pipefail
    mkdir -p {{weights_dir}}
    
    # Check if weights already exist
    if [ -f "{{weights_dir}}/vgg_normalised.pth" ] && [ -d "{{weights_dir}}/AdaAttN" ]; then
        echo "✓ Weights already downloaded"
        exit 0
    fi
    
    gdrive_url="https://drive.google.com/file/d/{{gdrive_model_id}}/view"
    zip_file="{{weights_dir}}/AdaAttN_model.zip"
    
    # Try download with retries (Google Drive can be flaky)
    for attempt in 1 2 3; do
        echo "Attempt $attempt/3: Downloading AdaAttN weights..."
        if uv run gdown --fuzzy "$gdrive_url" -O "$zip_file"; then
            unzip -o "$zip_file" -d {{weights_dir}}
            rm "$zip_file"
            echo "✓ Weights downloaded and extracted"
            exit 0
        fi
        echo "Download failed, retrying in $((attempt * 5))s..."
        sleep $((attempt * 5))
    done
    
    echo ""
    echo "Auto-download failed after 3 attempts."
    echo "Download manually from: $gdrive_url"
    echo ""
    echo "Expected structure after extraction:"
    echo "  {{weights_dir}}/"
    echo "  ├── vgg_normalised.pth"
    echo "  └── AdaAttN/"
    echo "      ├── latest_net_decoder.pth"
    echo "      ├── latest_net_transformer.pth"
    echo "      └── latest_net_adaattn_3.pth"
    exit 1

# =============================================================================
# GENERATE - Called from root: just gen adaattn <style> <n>
# =============================================================================

# Generate N images from COCO with given style
# Output: ../data/outputs/adaattn_{style}_{n}/
gen style n:
    #!/usr/bin/env bash
    set -eu
    if [ ! -d "{{coco_dir}}" ]; then
        echo "COCO not found. Run: just download-coco"
        exit 1
    fi
    if [ ! -f "{{weights_dir}}/vgg_normalised.pth" ]; then
        echo "Weights not found. Run: just setup adaattn"
        exit 1
    fi
    
    # Find style image
    style_file=""
    for ext in "" ".jpg" ".jpeg" ".png"; do
        if [ -f "{{style_dir}}/{{style}}${ext}" ]; then
            style_file="{{style}}${ext}"
            break
        fi
    done
    if [ -z "$style_file" ]; then
        echo "Style not found: {{style}} in {{style_dir}}"
        exit 1
    fi
    
    output_dir="{{outputs_dir}}/adaattn_{{style}}_{{n}}"
    mkdir -p "$output_dir"
    
    # Get first N COCO images
    content_files=$(find "{{coco_dir}}" -maxdepth 1 -type f -name "*.jpg" | sort | head -{{n}} | xargs -n1 basename | tr '\n' ' ')
    
    echo "Generating {{n}} images with {{style}}..."
    uv run python generate.py \
        --content-dir {{coco_dir}} \
        --style-dir {{style_dir}} \
        --checkpoint-dir {{weights_dir}} \
        --output-dir "$output_dir" \
        --styles {{style}} \
        --content-images $content_files
    
    echo "✓ Output: $output_dir ($(ls $output_dir | wc -l) files)"

# =============================================================================
# UTILITIES
# =============================================================================

list-styles:
    #!/usr/bin/env bash
    echo "Available styles in {{style_dir}}:"
    ls {{style_dir}}/*.{jpg,jpeg,png} 2>/dev/null | xargs -rn1 basename | sed 's/\.[^.]*$//' || echo "(none - run: just download-styles)"

check-weights:
    #!/usr/bin/env bash
    echo "Checking weights in {{weights_dir}}:"
    [ -f "{{weights_dir}}/vgg_normalised.pth" ] && echo "  ✓ vgg_normalised.pth" || echo "  ✗ vgg_normalised.pth missing"
    [ -f "{{weights_dir}}/AdaAttN/latest_net_decoder.pth" ] && echo "  ✓ AdaAttN/latest_net_decoder.pth" || echo "  ✗ AdaAttN/latest_net_decoder.pth missing"
    [ -f "{{weights_dir}}/AdaAttN/latest_net_transformer.pth" ] && echo "  ✓ AdaAttN/latest_net_transformer.pth" || echo "  ✗ AdaAttN/latest_net_transformer.pth missing"
    [ -f "{{weights_dir}}/AdaAttN/latest_net_adaattn_3.pth" ] && echo "  ✓ AdaAttN/latest_net_adaattn_3.pth" || echo "  ✗ AdaAttN/latest_net_adaattn_3.pth missing"

clean:
    rm -rf {{outputs_dir}}/adaattn_*

