# baselines/justfile - Data management
#
# All data lives in data/ (gitignored):
#   data/
#   ├── coco/val2017/     # COCO images
#   ├── style/            # Style images
#   ├── weights/gbgst/    # Model weights
#   └── outputs/          # Generated outputs

set dotenv-load

data_dir := "data"
coco_dir := data_dir / "coco/val2017"
style_dir := data_dir / "style"

github_gbgst := "https://raw.githubusercontent.com/ioannouE/GBGST/main"
game_videos := "1ITJZaIrGZohzVK_jiXa529OnqMMj0MxM"

# =============================================================================
# DOWNLOAD DATA
# =============================================================================

# Download style images
download-styles:
    #!/usr/bin/env bash
    set -euo pipefail
    mkdir -p {{style_dir}}
    styles="starry_night mosaic feathers wave composition_vii"
    for style in $styles; do
        if [ ! -f "{{style_dir}}/${style}.jpg" ]; then
            echo "Downloading ${style}.jpg..."
            curl -fSL -o "{{style_dir}}/${style}.jpg" \
                "{{github_gbgst}}/images/styles/${style}.jpg"
        else
            echo "✓ ${style}.jpg exists"
        fi
    done

# Download COCO val2017 (~5K images, 1GB)
download-coco: _shared-sync
    cd shared && uv run python download_coco.py --output-dir ../{{data_dir}}/coco --split val2017

# Download game videos
download-game-videos:
    wget -O videos.zip --no-check-certificate "https://drive.usercontent.google.com/download?id={{game_videos}}&export=download&confirm=t"
    unzip -o videos.zip -d data
    mv data/rt-games-style-videos data/videos
    rm videos.zip

_shared-sync:
    cd shared && uv sync

# =============================================================================
# STATUS
# =============================================================================

data-status:
    #!/usr/bin/env bash
    echo "Data status:"
    [ -d "{{style_dir}}" ] && echo "  ✓ style/ ($(ls {{style_dir}} 2>/dev/null | wc -l) files)" || echo "  ○ style/ (run: just download-styles)"
    [ -d "{{coco_dir}}" ] && echo "  ✓ coco/ ($(ls {{coco_dir}} 2>/dev/null | wc -l) files)" || echo "  ○ coco/ (run: just download-coco)"
    echo ""
    echo "Outputs:"
    for dir in {{data_dir}}/outputs/*/; do
        [ -d "$dir" ] || continue
        name=$(basename "$dir")
        count=$(ls "$dir" 2>/dev/null | wc -l)
        echo "  $name/ ($count files)"
    done

# Clean all outputs
clean:
    rm -rf {{data_dir}}/outputs/*
