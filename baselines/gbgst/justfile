# GBGST baseline - G-buffer Guided Style Transfer
# https://github.com/ioannouE/GBGST

set dotenv-load

# Paths - all data in ../data/
data_dir := "../data"
coco_dir := data_dir / "coco/val2017"
style_dir := data_dir / "style"
weights_dir := data_dir / "weights/gbgst"
outputs_dir := data_dir / "outputs"

submodule := "repo/saved_models"
github_raw := "https://github.com/ioannouE/GBGST/raw/main/saved_models"
styles := "starry_night mosaic feathers wave composition_vii"

# =============================================================================
# SETUP
# =============================================================================

setup: init-submodule sync link-weights
    @echo "✓ GBGST ready!"

init-submodule:
    #!/usr/bin/env bash
    set -euo pipefail
    [ -f "repo/README.md" ] && echo "Submodule OK" && exit 0
    cd ../.. && git submodule update --init baselines/gbgst/repo

sync:
    uv sync

link-weights:
    #!/usr/bin/env bash
    set -euo pipefail
    mkdir -p {{weights_dir}}
    [ -d "{{submodule}}" ] || { echo "Run 'just init-submodule' first"; exit 1; }
    for style in {{styles}}; do
        src="{{submodule}}/${style}.pth"
        if [ -f "$src" ]; then
            ln -sf "$(cd $(dirname $src) && pwd)/${style}.pth" "{{weights_dir}}/${style}.pth"
            echo "✓ ${style}.pth"
        fi
    done

download-weights:
    #!/usr/bin/env bash
    set -euo pipefail
    mkdir -p {{weights_dir}}
    for style in {{styles}}; do
        [ -f "{{weights_dir}}/${style}.pth" ] && echo "✓ ${style}.pth" && continue
        echo "Downloading ${style}.pth..."
        curl -fSL -o "{{weights_dir}}/${style}.pth" "{{github_raw}}/${style}.pth"
    done

# =============================================================================
# GENERATE - Called from root: just gen gbgst <style> <n>
# =============================================================================

# Generate N images from COCO with given style
# Output: ../data/outputs/gbgst_{style}_{n}/
gen style n:
    #!/usr/bin/env bash
    set -eu
    if [ ! -d "{{coco_dir}}" ]; then
        echo "COCO not found. Run: just download-coco"
        exit 1
    fi
    if [ ! -f "{{weights_dir}}/{{style}}.pth" ]; then
        echo "Weight not found: {{style}}.pth. Run: just setup gbgst"
        exit 1
    fi
    
    output_dir="{{outputs_dir}}/gbgst_{{style}}_{{n}}"
    mkdir -p "$output_dir"
    
    # Get first N COCO images
    content_files=$(find "{{coco_dir}}" -maxdepth 1 -type f -name "*.jpg" | sort | head -{{n}} | xargs -n1 basename | tr '\n' ' ')
    
    echo "Generating {{n}} images with {{style}}..."
    uv run python generate.py \
        --content-dir {{coco_dir}} \
        --style-dir {{style_dir}} \
        --weights-dir {{weights_dir}} \
        --output-dir "$output_dir" \
        --styles {{style}} \
        --content-images $content_files
    
    echo "✓ Output: $output_dir ($(ls $output_dir | wc -l) files)"

# =============================================================================
# UTILITIES
# =============================================================================

list-weights:
    @ls -la {{weights_dir}}/*.pth 2>/dev/null || echo "(none)"

clean:
    rm -rf {{outputs_dir}}/gbgst_*
